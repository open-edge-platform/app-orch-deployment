# yamllint disable-file
# SPDX-FileCopyrightText: (C) 2023 Intel Corporation
#
# SPDX-License-Identifier: Apache-2.0
{{- if .Values.metrics.enabled }}
---
apiVersion: v1
kind: Service
metadata:
  labels:
    {{- include "app-service-proxy.labels" . | nindent 4 }}
  name: {{ template "app-service-proxy.name" . }}-metrics
spec:
  ports:
    - name: http-metrics
      port: {{ .Values.metrics.port }}
      protocol: TCP
      targetPort: http-metrics
  selector:
    {{- include "app-service-proxy.labels" . | nindent 4 }}
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    {{- include "app-service-proxy.labels" . | nindent 4 }}
  name: {{ template "app-service-proxy.name" . }}
spec:
  endpoints:
  - port: http-metrics
    scheme: http
    path: /metrics
  namespaceSelector:
    matchNames:
    - {{ .Release.Namespace }}
  selector:
    matchExpressions:
    - key: prometheus.io/service-monitor
      operator: NotIn
      values:
      - "false"
    matchLabels:
      {{- include "app-service-proxy.labels" . | nindent 6 }}
{{- end }}